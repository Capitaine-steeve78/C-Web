name: V2üìä Daily GitHub Traffic Report

permissions:
  contents: read
  metadata: read

on:
  schedule:
    - cron: "15 17 * * *"
  workflow_dispatch:

jobs:
  send_traffic_report:
    runs-on: ubuntu-latest

    steps:
      - name: üïí Set date
        run: echo "DATE=$(date '+%Y-%m-%d')" >> $GITHUB_ENV

      - name: ‚úÖ Ensure jq is installed
        run: |
          if ! command -v jq >/dev/null 2>&1; then
            sudo apt-get update
            sudo apt-get install -y jq
          fi

      - name: üîê Prepare token
        run: |
          # If you set a PAT in secrets.PAT_TOKEN it will be used (recommended for private repos/traffic access).
          # Otherwise fall back to the automatically provided GITHUB_TOKEN.
          if [ -n "${{ secrets.PAT_TOKEN }}" ]; then
            echo "TOKEN=${{ secrets.PAT_TOKEN }}" >> $GITHUB_ENV
          else
            echo "TOKEN=${{ secrets.GITHUB_TOKEN }}" >> $GITHUB_ENV
          fi

      - name: üì• Fetch GitHub traffic data (with checks)
        id: fetch
        env:
          TOKEN: ${{ env.TOKEN }}
        run: |
          OWNER=$(echo "${{ github.repository }}" | cut -d'/' -f1)
          REPO=$(echo "${{ github.repository }}" | cut -d'/' -f2)

          # Fetch views
          HTTP_VIEWS=$(mktemp)
          HTTP_CLONES=$(mktemp)

          HTTP_CODE_VIEWS=$(curl -sS -w "%{http_code}" -o $HTTP_VIEWS -H "Accept: application/vnd.github+json" -H "Authorization: Bearer $TOKEN" "https://api.github.com/repos/$OWNER/$REPO/traffic/views")
          HTTP_CODE_CLONES=$(curl -sS -w "%{http_code}" -o $HTTP_CLONES -H "Accept: application/vnd.github+json" -H "Authorization: Bearer $TOKEN" "https://api.github.com/repos/$OWNER/$REPO/traffic/clones")

          if [ "$HTTP_CODE_VIEWS" -ne 200 ]; then
            echo "Failed to fetch views: HTTP $HTTP_CODE_VIEWS. Response:"
            cat $HTTP_VIEWS || true
            exit 1
          fi

          if [ "$HTTP_CODE_CLONES" -ne 200 ]; then
            echo "Failed to fetch clones: HTTP $HTTP_CODE_CLONES. Response:"
            cat $HTTP_CLONES || true
            exit 1
          fi

          VIEWS_JSON=$(cat $HTTP_VIEWS)
          CLONES_JSON=$(cat $HTTP_CLONES)

          # Safe extraction using 'last' and fallbacks
          echo "TOTAL_VIEWS=$(echo "$VIEWS_JSON" | jq -r '.count // 0')" >> $GITHUB_ENV
          echo "UNIQUE_VIEWS=$(echo "$VIEWS_JSON" | jq -r '.uniques // 0')" >> $GITHUB_ENV
          echo "TOTAL_CLONES=$(echo "$CLONES_JSON" | jq -r '.count // 0')" >> $GITHUB_ENV
          echo "UNIQUE_CLONES=$(echo "$CLONES_JSON" | jq -r '.uniques // 0')" >> $GITHUB_ENV

          echo "TODAY_VIEWS=$(echo "$VIEWS_JSON" | jq -r '(.views | last // {count:0}).count // 0')" >> $GITHUB_ENV
          echo "TODAY_UNIQUE_VIEWS=$(echo "$VIEWS_JSON" | jq -r '(.views | last // {uniques:0}).uniques // 0')" >> $GITHUB_ENV
          echo "TODAY_CLONES=$(echo "$CLONES_JSON" | jq -r '(.clones | last // {count:0}).count // 0')" >> $GITHUB_ENV
          echo "TODAY_UNIQUE_CLONES=$(echo "$CLONES_JSON" | jq -r '(.clones | last // {uniques:0}).uniques // 0')" >> $GITHUB_ENV

      - name: üí¨ Send to Discord
        env:
          DATE: ${{ env.DATE }}
          VIEWS: ${{ env.TOTAL_VIEWS }}
          UNIQUE_VIEWS: ${{ env.UNIQUE_VIEWS }}
          CLONES: ${{ env.TOTAL_CLONES }}
          UNIQUE_CLONES: ${{ env.UNIQUE_CLONES }}
          TODAY_VIEWS: ${{ env.TODAY_VIEWS }}
          TODAY_UNIQUE_VIEWS: ${{ env.TODAY_UNIQUE_VIEWS }}
          TODAY_CLONES: ${{ env.TODAY_CLONES }}
          TODAY_UNIQUE_CLONES: ${{ env.TODAY_UNIQUE_CLONES }}
        run: |
          PAYLOAD=$(jq -n \
            --arg date "$DATE" \
            --arg repo "${{ github.repository }}" \
            --arg views "$VIEWS" \
            --arg uviews "$UNIQUE_VIEWS" \
            --arg clones "$CLONES" \
            --arg uclones "$UNIQUE_CLONES" \
            --arg tviews "$TODAY_VIEWS" \
            --arg tuviews "$TODAY_UNIQUE_VIEWS" \
            --arg tclones "$TODAY_CLONES" \
            --arg tuclones "$TODAY_UNIQUE_CLONES" \
            '{ 
              "content": "<@1012992849547104316>", 
              "embeds": [{ 
                "title": " > üìä Rapport GitHub du \($date)", 
                "color": 5814783, 
                "fields": [ 
                  {"name": "üìÖ Aujourd‚Äôhui", "value": "‚Äî---------------", "inline": false}, 
                  {"name": "üëÅÔ∏è Vues", "value": $tviews, "inline": true}, 
                  {"name": "üë§ Visiteurs uniques", "value": $tuviews, "inline": true}, 
                  {"name": "üì¶ Clones", "value": $tclones, "inline": true}, 
                  {"name": "üßë‚Äçüíª Cloneurs uniques", "value": $tuclones, "inline": true},
                  {"name": " > üìä Sur 14 jours", "value": "‚Äî---------------", "inline": false}, 
                  {"name": "üëÅÔ∏è Vues totales", "value": $views, "inline": true}, 
                  {"name": "üë§ Visiteurs uniques", "value": $uviews, "inline": true}, 
                  {"name": "üì¶ Clones totaux", "value": $clones, "inline": true}, 
                  {"name": "üßë‚Äçüíª Cloneurs uniques", "value": $uclones, "inline": true} 
                ], 
                "footer": {"text": "GitHub Actions ‚Ä¢ \($repo)"} 
              }] 
            }')

          curl -s -H "Content-Type: application/json" -d "$PAYLOAD" "${{ secrets.DISCORD_WEBHOOK }}"

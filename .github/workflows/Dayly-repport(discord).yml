name: ðŸ“Š Daily GitHub Traffic Report

on:
  schedule:
    - cron: "0 17 * * *"  # Tous les jours Ã  18h UTC
  workflow_dispatch:       # Permet de le lancer manuellement

jobs:
  send_traffic_report:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ•’ Set date
        run: echo "DATE=$(date '+%Y-%m-%d')" >> $GITHUB_ENV

      - name: ðŸ“¥ Fetch GitHub traffic data
        id: fetch
        run: |
          echo "Fetching GitHub traffic data..."

          TOKEN="${{ secrets.PERSONAL_TOKEN || secrets.GITHUB_TOKEN }}"
          OWNER=$(echo "${{ github.repository }}" | cut -d'/' -f1)
          REPO=$(echo "${{ github.repository }}" | cut -d'/' -f2)

          # Views
          VIEWS_JSON=$(curl -s -H "Accept: application/vnd.github+json" \
                            -H "Authorization: Bearer $TOKEN" \
                            "https://api.github.com/repos/$OWNER/$REPO/traffic/views")

          # Clones
          CLONES_JSON=$(curl -s -H "Accept: application/vnd.github+json" \
                             -H "Authorization: Bearer $TOKEN" \
                             "https://api.github.com/repos/$OWNER/$REPO/traffic/clones")

          echo "Views API response: $VIEWS_JSON"
          echo "Clones API response: $CLONES_JSON"

          # Extract totals
          TOTAL_VIEWS=$(echo "$VIEWS_JSON" | jq -r '.count // 0')
          UNIQUE_VIEWS=$(echo "$VIEWS_JSON" | jq -r '.uniques // 0')
          TOTAL_CLONES=$(echo "$CLONES_JSON" | jq -r '.count // 0')
          UNIQUE_CLONES=$(echo "$CLONES_JSON" | jq -r '.uniques // 0')

          echo "TOTAL_VIEWS=$TOTAL_VIEWS" >> $GITHUB_ENV
          echo "UNIQUE_VIEWS=$UNIQUE_VIEWS" >> $GITHUB_ENV
          echo "TOTAL_CLONES=$TOTAL_CLONES" >> $GITHUB_ENV
          echo "UNIQUE_CLONES=$UNIQUE_CLONES" >> $GITHUB_ENV

      - name: ðŸ’¬ Send to Discord
        if: ${{ env.TOTAL_VIEWS != '' }}
        run: |
          DATE="${{ env.DATE }}"
          VIEWS="${{ env.TOTAL_VIEWS }}"
          UVIEWS="${{ env.UNIQUE_VIEWS }}"
          CLONES="${{ env.TOTAL_CLONES }}"
          UCLONES="${{ env.UNIQUE_CLONES }}"

          PAYLOAD=$(jq -n \
            --arg title "ðŸ“Š Rapport GitHub du $DATE" \
            --arg desc "**Vues totales :** $VIEWS\n**Vues uniques :** $UVIEWS\n**Clones totaux :** $CLONES\n**Clones uniques :** $UCLONES" \
            '{embeds: [{title: $title, description: $desc, color: 5814783}]}')

          curl -s -H "Content-Type: application/json" \
               -d "$PAYLOAD" \
               "${{ secrets.DISCORD_WEBHOOK }}"

name: Daily Traffic Report

on:
  schedule:
    # Tous les jours √† 17h UTC = 18h heure fran√ßaise
    - cron: '0 17 * * *'
  workflow_dispatch:

permissions:
  contents: read  # N√©cessaire pour lire les stats du d√©p√¥t

jobs:
  report:
    runs-on: ubuntu-latest

    steps:
      - name: Get traffic stats
        id: traffic
        run: |
          echo "Fetching GitHub traffic data..."

          # --- R√©cup√©ration des vues ---
          curl -s -H "Accept: application/vnd.github+json" \
               -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
               https://api.github.com/repos/${{ github.repository }}/traffic/views > views.json

          # --- R√©cup√©ration des clones ---
          curl -s -H "Accept: application/vnd.github+json" \
               -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
               https://api.github.com/repos/${{ github.repository }}/traffic/clones > clones.json

          echo "Views API response:"; cat views.json
          echo "Clones API response:"; cat clones.json

          # --- Extraction des valeurs ---
          VIEWS=$(jq '.count // 0' views.json)
          UNIQUE_VIEWS=$(jq '.uniques // 0' views.json)
          CLONES=$(jq '.count // 0' clones.json)
          UNIQUE_CLONES=$(jq '.uniques // 0' clones.json)
          DATE=$(date '+%d/%m/%Y')

          echo "views=$VIEWS" >> $GITHUB_OUTPUT
          echo "unique_views=$UNIQUE_VIEWS" >> $GITHUB_OUTPUT
          echo "clones=$CLONES" >> $GITHUB_OUTPUT
          echo "unique_clones=$UNIQUE_CLONES" >> $GITHUB_OUTPUT
          echo "date=$DATE" >> $GITHUB_OUTPUT

      - name: Send report to Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          if [ -z "$DISCORD_WEBHOOK" ]; then
            echo "‚ùå Webhook Discord manquant dans les secrets !"
            exit 1
          fi

          VIEWS=${{ steps.traffic.outputs.views }}
          UNIQUE_VIEWS=${{ steps.traffic.outputs.unique_views }}
          CLONES=${{ steps.traffic.outputs.clones }}
          UNIQUE_CLONES=${{ steps.traffic.outputs.unique_clones }}
          DATE=${{ steps.traffic.outputs.date }}

          # Cr√©ation du message Discord (version corrig√©e sans bug jq)
          PAYLOAD=$(jq -n \
            --arg date "$DATE" \
            --arg views "$VIEWS" \
            --arg uviews "$UNIQUE_VIEWS" \
            --arg clones "$CLONES" \
            --arg uclones "$UNIQUE_CLONES" \
            --arg repo "${{ github.repository }}" \
            '{
              "embeds": [{
                "title": "üìä Rapport GitHub du \($date)",
                "color": 5814783,
                "fields": [
                  {"name": "üëÅÔ∏è Vues totales", "value": $views, "inline": true},
                  {"name": "üë§ Visiteurs uniques", "value": $uviews, "inline": true},
                  {"name": "üì¶ Clones", "value": $clones, "inline": true},
                  {"name": "üßë‚Äçüíª Cloneurs uniques", "value": $uclones, "inline": true}
                ],
                "footer": {"text": "GitHub Actions ‚Ä¢ \($repo)"}
              }]
            }')

          # Envoi √† Discord
          curl -X POST -H "Content-Type: application/json" \
               -d "$PAYLOAD" "$DISCORD_WEBHOOK"

name: Daily Traffic Report

on:
  schedule:
    - cron: '0 17 * * *'  # Tous les jours Ã  18h (heure de France, hiver)
  workflow_dispatch:

permissions:
  contents: read 

jobs:
  report:
    runs-on: ubuntu-latest

    steps:
      - name: Get traffic stats
        id: traffic
        run: |
          echo "Fetching GitHub traffic data..."

          # RÃ©cupÃ©ration des vues
          curl -s -H "Accept: application/vnd.github+json" \
               -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
               https://api.github.com/repos/${{ github.repository }}/traffic/views > views.json

          # RÃ©cupÃ©ration des clones
          curl -s -H "Accept: application/vnd.github+json" \
               -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
               https://api.github.com/repos/${{ github.repository }}/traffic/clones > clones.json

          # Extraction des donnÃ©es via jq
          VIEWS=$(jq '.count' views.json)
          UNIQUE_VIEWS=$(jq '.uniques' views.json)
          CLONES=$(jq '.count' clones.json)
          UNIQUE_CLONES=$(jq '.uniques' clones.json)
          DATE=$(date '+%d/%m/%Y')

          echo "views=$VIEWS" >> $GITHUB_OUTPUT
          echo "unique_views=$UNIQUE_VIEWS" >> $GITHUB_OUTPUT
          echo "clones=$CLONES" >> $GITHUB_OUTPUT
          echo "unique_clones=$UNIQUE_CLONES" >> $GITHUB_OUTPUT
          echo "date=$DATE" >> $GITHUB_OUTPUT

      - name: Send Discord report
        run: |
          json=$(jq -n \
            --arg repo "${{ github.repository }}" \
            --arg date "${{ steps.traffic.outputs.date }}" \
            --arg views "${{ steps.traffic.outputs.views }}" \
            --arg unique_views "${{ steps.traffic.outputs.unique_views }}" \
            --arg clones "${{ steps.traffic.outputs.clones }}" \
            --arg unique_clones "${{ steps.traffic.outputs.unique_clones }}" \
            '{
              "embeds": [
                {
                  "title": "ğŸ“Š Rapport quotidien â€“ \($repo)",
                  "description": "**RÃ©sumÃ© des statistiques du dÃ©pÃ´t**",
                  "color": 5814783,
                  "fields": [
                    { "name": "ğŸ‘ï¸ Vues totales", "value": "\($views)", "inline": true },
                    { "name": "ğŸ‘¤ Visiteurs uniques", "value": "\($unique_views)", "inline": true },
                    { "name": "ğŸ“¥ Clones", "value": "\($clones)", "inline": true },
                    { "name": "ğŸ’¾ Cloneurs uniques", "value": "\($unique_clones)", "inline": true }
                  ],
                  "footer": { "text": "ğŸ“… Rapport du \($date) Ã  18h" }
                }
              ]
            }')

          curl -H "Content-Type: application/json" \
               -d "$json" \
               ${{ secrets.DISCORD_WEBHOOK }}

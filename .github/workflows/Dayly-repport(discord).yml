name: ðŸ“Š Daily GitHub Traffic Report

on:
  schedule:
    - cron: "0 17 * * *"  # Tous les jours Ã  18h UTC
  workflow_dispatch:

jobs:
  send_traffic_report:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ•’ Set date
        run: echo "DATE=$(date '+%Y-%m-%d')" >> $GITHUB_ENV

      - name: ðŸ“¥ Fetch GitHub traffic data
        id: fetch
        run: |
          echo "Fetching GitHub traffic data..."

          TOKEN="${{ secrets.PERSONAL_TOKEN || secrets.GITHUB_TOKEN }}"
          OWNER=$(echo "${{ github.repository }}" | cut -d'/' -f1)
          REPO=$(echo "${{ github.repository }}" | cut -d'/' -f2)

          # Views & clones
          VIEWS_JSON=$(curl -s -H "Accept: application/vnd.github+json" \
                            -H "Authorization: Bearer $TOKEN" \
                            "https://api.github.com/repos/$OWNER/$REPO/traffic/views")

          CLONES_JSON=$(curl -s -H "Accept: application/vnd.github+json" \
                             -H "Authorization: Bearer $TOKEN" \
                             "https://api.github.com/repos/$OWNER/$REPO/traffic/clones")

          echo "Views API response: $VIEWS_JSON"
          echo "Clones API response: $CLONES_JSON"

          # Totaux (14 derniers jours)
          TOTAL_VIEWS=$(echo "$VIEWS_JSON" | jq -r '.count // 0')
          UNIQUE_VIEWS=$(echo "$VIEWS_JSON" | jq -r '.uniques // 0')
          TOTAL_CLONES=$(echo "$CLONES_JSON" | jq -r '.count // 0')
          UNIQUE_CLONES=$(echo "$CLONES_JSON" | jq -r '.uniques // 0')

          # DonnÃ©es du jour (dernier jour de la liste)
          TODAY_VIEWS=$(echo "$VIEWS_JSON" | jq -r '.views[-1].count // 0')
          TODAY_UNIQUE_VIEWS=$(echo "$VIEWS_JSON" | jq -r '.views[-1].uniques // 0')
          TODAY_CLONES=$(echo "$CLONES_JSON" | jq -r '.clones[-1].count // 0')
          TODAY_UNIQUE_CLONES=$(echo "$CLONES_JSON" | jq -r '.clones[-1].uniques // 0')

          echo "TOTAL_VIEWS=$TOTAL_VIEWS" >> $GITHUB_ENV
          echo "UNIQUE_VIEWS=$UNIQUE_VIEWS" >> $GITHUB_ENV
          echo "TOTAL_CLONES=$TOTAL_CLONES" >> $GITHUB_ENV
          echo "UNIQUE_CLONES=$UNIQUE_CLONES" >> $GITHUB_ENV
          echo "TODAY_VIEWS=$TODAY_VIEWS" >> $GITHUB_ENV
          echo "TODAY_UNIQUE_VIEWS=$TODAY_UNIQUE_VIEWS" >> $GITHUB_ENV
          echo "TODAY_CLONES=$TODAY_CLONES" >> $GITHUB_ENV
          echo "TODAY_UNIQUE_CLONES=$TODAY_UNIQUE_CLONES" >> $GITHUB_ENV

      - name: ðŸ’¬ Send to Discord
        run: |
          DATE="${{ env.DATE }}"

          PAYLOAD=$(jq -n \
            --arg title "ðŸ“Š Rapport GitHub du $DATE" \
            --arg desc "**ðŸ“… Aujourdâ€™hui :**\\u000Aâ€¢ Vues : ${{ env.TODAY_VIEWS }} (uniques : ${{ env.TODAY_UNIQUE_VIEWS }})\\u000Aâ€¢ Clones : ${{ env.TODAY_CLONES }} (uniques : ${{ env.TODAY_UNIQUE_CLONES }})\\u000A\\u000A**ðŸ“Š 14 derniers jours :**\\u000Aâ€¢ Vues totales : ${{ env.TOTAL_VIEWS }} (uniques : ${{ env.UNIQUE_VIEWS }})\\u000Aâ€¢ Clones totaux : ${{ env.TOTAL_CLONES }} (uniques : ${{ env.UNIQUE_CLONES }})" \
            '{embeds: [{title: $title, description: $desc, color: 5814783}]}')

          curl -s -H "Content-Type: application/json" \
            -d "$PAYLOAD" \
           "${{ secrets.DISCORD_WEBHOOK }}"
